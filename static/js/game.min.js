var Game;(function(q){let n;(function(o){o[o.None=0]="None",o[o.Splash=1]="Splash",o[o.Play=2]="Play",o[o.Countdown=3]="Countdown",o[o.AnimatePath=4]="AnimatePath",o[o.Paused=5]="Paused",o[o.Help=6]="Help",o[o.Wrong=7]="Wrong",o[o.Won=8]="Won",o[o.Lost=9]="Lost",o[o.Start=10]="Start"})(n||(n={}));const m={N:{dx:0,dy:-1},S:{dx:0,dy:1},E:{dx:1,dy:0},W:{dx:-1,dy:0},NE:{dx:1,dy:-1},NW:{dx:-1,dy:-1},SE:{dx:1,dy:1},SW:{dx:-1,dy:1}};Object.freeze(m);const f={};Object.keys(m).forEach(o=>{const e=m[o];f[`${e.dx},${e.dy}`]=o}),Object.freeze(f);const D={NE:7,E:6,SE:5,S:4,SW:3,W:2,NW:1,N:0};Object.freeze(D);class g extends HTMLElement{constructor(){super(),this._state=n.None,this.lastTapTime=0,this._soundEnabled=!0,this.sounds={},this._path=[],this.pathIndex=0,this.t0=performance.now(),this.elapsed=0,this.prelude=!0}connectedCallback(){this.shadow=this.attachShadow({mode:"open"}),this.dynamicStyles=document.createElement("style");const e=document.createElement("style");e.textContent=`
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    touch-action: manipulation;
    font-size: calc(var(--cell-size) / 2);
}
#board {
    position: relative;
    margin: 0 auto;
    width: fit-content;
    display: grid;
    grid-template-columns: repeat(var(--tiles-per-row), var(--cell-size));
    grid-template-rows: repeat(--tiles-per-col, var(--cell-size));
    gap: calc(var(--cell-size) / 10);
}
#board.locked > div.tile {
    cursor: not-allowed;
}
#board.wrong > div.tile {
    background-color: var(--wrong-color) !important;
    box-shadow: 0 0 calc(var(--cell-size) / 10) calc(var(--cell-size) / 30) var(--wrong-color) !important;
    cursor: not-allowed;
}
.tile {
    display: block;
    box-sizing: content-box;
    width: var(--cell-size);
    height: var(--cell-size);
    background-color: var(--tile-color);
    border-radius: calc(var(--cell-size) / 30);
    cursor: pointer;
    text-align: center;
    line-height: var(--cell-size);
    transition: background-color 60ms, box-shadow 60ms;
}
.tile.path {
    animation-name: path;
    animation-iteration-count: 1;
    animation-fill-mode: alternate;
    animation-timing-function: cubic-bezier(.32,.36,.04,.96);
}
.tile.visited {
    background-color: var(--visited-color);
    box-shadow: 0 0 calc(var(--cell-size) / 6) calc(var(--cell-size) / 30) var(--visited-color);
}

@keyframes path {
    0% {
        background-color: var(--tile-color);
    }
    50% {
        background-color: var(--path-color);
        box-shadow: 0 0 calc(var(--cell-size) / 7) calc(var(--cell-size) / 30) var(--path-color);
    }
}
`,this.board=document.createElement("div"),this.board.classList.add("locked"),this.board.id="board",this.shadow.appendChild(this.board),this.shadow.appendChild(this.dynamicStyles),this.shadow.appendChild(e),this.activateEventListeners(),this.initAudio()}updateDynamicStyles(){this.dynamicStyles.textContent=`
:host {
    --cell-size: ${80/Math.max(this.levelData.width,this.levelData.height)}vmin;
    --tiles-per-row: ${this.levelData.width};
    --tiles-per-col: ${this.levelData.height};
}
.tile.path {
    animation-duration: ${this.levelData.tileAnimationDurationSecs}s;
}
`}adjustSize(){this.updateDynamicStyles()}buildBoard(){this.tiles=Array.from({length:this.levelData.height},()=>Array(this.levelData.width).fill(null));for(let e=0;e<this.levelData.height;++e)for(let a=0;a<this.levelData.width;++a){const s=document.createElement("div");s.classList.add("tile"),s.dataset.x=a.toString(),s.dataset.y=e.toString(),this.tiles[e][a]=s}this.board.addEventListener("click",e=>{e.target.classList.contains("tile")&&this.onTileClick(e)}),this.board.replaceChildren(...this.tiles.flat())}set difficulty(e){console.assert(0<=e&&e<=9,"Difficulty must be between 0 and 9"),this.levelData={crossingAllowed:e>5,directionProbs:[[.16,.42,.16],[.08,0,.08],[0,0,0]],forbiddenTurns:function(a){return a>5?{}:{NE:["S","W","SW"],NW:["S","E","SE"],SE:["N","W","NW"],SW:["N","E","NE"],N:["SW","SE","S"],E:["NW","SW","W"],S:["NE","NW","N"],W:["NE","SE","E"]}}(e),width:4+e,height:4+e,secsToSolve:Math.floor(30-e*2),tileAnimationDurationSecs:1.5,numStepsRequired:Math.floor(4+e+1.2*e),numTurnsRequired:Math.floor(.5*e+1)},console.debug(JSON.stringify(this.levelData)),this.updateDynamicStyles(),this.buildBoard(),this.createPath()}static rotateCW(e,a=1){const s=Array.from({length:3},()=>Array(3).fill(0));s[1][1]=e[1][1];for(let r=0;r<a;++r)s[0][2]=e[0][1],s[0][1]=e[0][0],s[2][0]=e[2][1],s[2][1]=e[2][2],s[2][2]=e[1][2],s[1][2]=e[0][2],s[0][0]=e[1][0],s[1][0]=e[2][0],e=s.map(l=>l.slice());return e}animatePath(){const e=this.levelData.tileAnimationDurationSecs/(this._path.length*3);this._path.forEach(({x:a,y:s},r)=>{const l=this.tiles[s][a];l.classList.add("path"),l.style.animationDelay=`${r*e}s`})}createPath(){console.debug("createPath()");const e=performance.now();let a,s,r,l=0;do{++l,console.debug(`Attempt #${l}`),a=[];const c=Array.from({length:this.levelData.height},()=>Array(this.levelData.width).fill(!1));s={x:Math.floor(Math.random()*this.levelData.width),y:this.levelData.height-1},c[s.y][s.x]=!0,a.push({...s});let d=["N","E","W"][Math.floor(Math.random()*3)];for(r=0;s.y>0&&(a.length<this.levelData.numStepsRequired||r<this.levelData.numTurnsRequired);){const S=Object.values(m).map(i=>({x:s.x+i.dx,y:s.y+i.dy})).filter(i=>i.x>=0&&i.x<this.levelData.width&&i.y>=0&&i.y<this.levelData.height).filter(i=>!c[i.y][i.x]),b=this.levelData.crossingAllowed?S:S.filter(i=>{const h=i.x-s.x,v=i.y-s.y;if(h!==0&&v!==0){const u={x:s.x,y:i.y},T={x:i.x,y:s.y};if(c[u.y][u.x]&&c[T.y][T.x])return!1}return!0});let x=g.rotateCW(this.levelData.directionProbs.map(i=>i.slice()),D[d]);const k=b.reduce((i,h)=>{const v=h.x-s.x,u=h.y-s.y;return i+x[u+1][v+1]},0);if(k===0||b.length===0)break;const F=Math.random()*k;let y=0,p;for(const i of b){const h=i.x-s.x,v=i.y-s.y,u=x[v+1][h+1];if(y+=u,!(F>=y)){if(p=f[`${h},${v}`],this.levelData.forbiddenTurns&&Array.isArray(this.levelData.forbiddenTurns[d])&&this.levelData.forbiddenTurns[d].includes(p)){y-=u;continue}c[i.y][i.x]=!0;break}}s={x:s.x+m[p].dx,y:s.y+m[p].dy},a.push({...s}),r+=d!==p?1:0,d=p}}while(a.length!==this.levelData.numStepsRequired||r!==this.levelData.numTurnsRequired||s.y!==0);this._path=a,console.debug(`New path created in ${performance.now()-e}ms after ${l} tries: ${a.map(({x:c,y:d})=>`(${c},${d})`).join(" \u2192 ")}`)}activateEventListeners(){addEventListener("touchstart",e=>this.onTouchStart(e),{passive:!1}),addEventListener("touchend",e=>this.onTouchEnd(e))}newGame(){this.prelude=!0,this.state=n.Start}update(){this.prelude||![n.AnimatePath,n.Play,n.Wrong].includes(this._state)||(this.elapsed=.001*(performance.now()-this.t0),dispatchEvent(new CustomEvent("countdown",{detail:Math.max(0,this.levelData.secsToSolve-this.elapsed).toFixed(2)})),this.elapsed>this.levelData.secsToSolve&&(this.state=n.Lost),this.animationFrameID=requestAnimationFrame(()=>this.update()))}set state(e){if(this._state!==e)switch(this._state=e,e){case n.Start:this.elapsed=0,this.state=n.Countdown,dispatchEvent(new CustomEvent("countdown",{detail:this.levelData.secsToSolve.toFixed(2)}));break;case n.Countdown:this.playSound("countdown"),dispatchEvent(new CustomEvent("showcountdown")),this.timeoutID=setTimeout(()=>{this.state=n.AnimatePath},1400);break;case n.AnimatePath:this.pathIndex=0,this.animatePath(),this.timeoutID=setTimeout(()=>{this.state=n.Play},1e3*this.levelData.tileAnimationDurationSecs),this.animationFrameID=requestAnimationFrame(()=>this.update());break;case n.Play:this.board.classList.remove("locked"),this.tiles.flat().forEach(a=>a.classList.remove("path")),this.t0=performance.now()-1e3*this.elapsed,this.animationFrameID=requestAnimationFrame(()=>this.update()),this.prelude=!1;break;case n.Wrong:this.playSound("alarm"),this.board.classList.add("wrong"),this.tiles.flat().forEach(a=>a.classList.remove("visited")),this.timeoutID=setTimeout(()=>{this.board.classList.remove("wrong"),.001*(performance.now()-this.t0)<this.levelData.secsToSolve&&(this.state=n.Countdown)},1e3*this.sounds.alarm.buffer.duration),this.animationFrameID=requestAnimationFrame(()=>this.update());break;case n.Paused:this.board.classList.add("locked"),dispatchEvent(new CustomEvent("pause")),cancelAnimationFrame(this.animationFrameID);break;case n.Won:this.board.classList.add("locked"),this.playSound("tada"),this.tiles.flat().forEach(a=>a.classList.remove("visited")),this.createPath(),dispatchEvent(new CustomEvent("wonlevel")),cancelAnimationFrame(this.animationFrameID),this.elapsed=0;break;case n.Lost:this.stopAllSounds(),this.playSound("alarm"),this.board.classList.remove("wrong"),this.tiles.flat().forEach(a=>a.classList.remove("visited","path")),this.createPath(),dispatchEvent(new CustomEvent("lostlevel")),clearTimeout(this.timeoutID),cancelAnimationFrame(this.animationFrameID);break;case n.Splash:t.countdown.textContent=this.levelData.secsToSolve.toFixed(2);break;default:break}}get state(){return this._state}onTileClick(e){if(e.preventDefault(),e.stopImmediatePropagation(),this._state!==n.Play)return;const a=e.target,s=parseInt(a.dataset.x),r=parseInt(a.dataset.y),l=this.tiles[r][s],c=this._path[this.pathIndex];c.x===s&&c.y===r?(this.playSound("step"),l.classList.add("visited"),++this.pathIndex,this.pathIndex===this._path.length&&(this.state=n.Won)):this.state=n.Wrong}onTouchStart(e){this.touchStartTime=performance.now()}onTouchEnd(e){const a=performance.now();if(a-this.touchStartTime<400){const l=e.changedTouches[0],c=document.elementFromPoint(l.clientX,l.clientY);if(c.classList.contains("tile")){const d=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window,clientX:l.clientX,clientY:l.clientY}),E=Object.create(d,{target:{value:c},currentTarget:{value:c}});this.onTileClick(E)}}const r=a-this.lastTapTime;r<500&&r>0&&e.preventDefault(),this.lastTapTime=a}set soundEnabled(e){this._soundEnabled=e,localStorage.setItem("tracer-sound-enabled",this.soundEnabled.toString())}get soundEnabled(){return this._soundEnabled}pause(){this.state=n.Paused}unpause(){this.state=n.Play}doPlaySound(e){const a=this.audioCtx.createBufferSource();a.buffer=this.sounds[e].buffer,a.connect(this.gainNode),a.start(),this.sounds[e].source=a}playSound(e){this.soundEnabled&&(this.audioCtx.state==="suspended"?this.resumeAudio().then(()=>{this.doPlaySound(e)}):this.doPlaySound(e))}stopSound(e){this.sounds[e].source&&this.sounds[e].source.stop()}stopAllSounds(){for(const e in this.sounds)this.stopSound(e)}resumeAudio(){return this.audioCtx.resume()}initAudio(){this.audioCtx=new AudioContext,this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=parseFloat(localStorage.getItem("tracer-sound-volume")||g.DEFAULT_GAIN_VALUE.toString()),this.gainNode.connect(this.audioCtx.destination);for(const e of["countdown","alarm","step","tada"])this.sounds[e]={},fetch(`static/sounds/${e}.mp3`).then(a=>a.arrayBuffer()).then(a=>this.audioCtx.decodeAudioData(a)).then(a=>{this.sounds[e].buffer=a}).catch(a=>{console.error("Failed to load sound:",a)})}}g.DEFAULT_GAIN_VALUE=.5;let t={};const w=document.location.hostname.startsWith("leuchtspur")?"de":"en";function L(o){switch(o.key){case"Escape":if(t.splash.open)return;switch(t.game.state){case n.Play:t.game.pause();break;case n.Paused:t.game.unpause();break;default:break}break;default:break}o.preventDefault(),o.stopImmediatePropagation()}function A(){const o=e=>{t.splash.close(),t.game.resumeAudio().then(()=>{t.game.difficulty=e,t.game.newGame()})};return t.splash=document.querySelector(`#splash-screen-${w}`),t.splash.addEventListener("cancel",e=>e.preventDefault()),t.splash.addEventListener("keydown",e=>{if("1"<=e.key&&e.key<="9"){t.splash.close();const a=parseInt(e.key)-1;o(a)}e.preventDefault(),e.stopImmediatePropagation()}),t.splash.addEventListener("click",e=>{if(e.target instanceof HTMLButtonElement){t.splash.close();const a=parseInt(e.target.textContent)-1;o(a)}e.stopImmediatePropagation(),e.preventDefault()}),t.splash}function P(){t.won=document.querySelector(`#won-dialog-${w}`),t.won.addEventListener("cancel",e=>e.preventDefault()),t.won.querySelector("button").addEventListener("click",e=>{t.won.close(),t.game.newGame(),e.stopImmediatePropagation()}),window.addEventListener("wonlevel",e=>{t.won.showModal()})}function C(){t.lost=document.querySelector(`#lost-dialog-${w}`),t.lost.addEventListener("cancel",e=>e.preventDefault()),t.lost.querySelector("button").addEventListener("click",e=>{t.lost.close(),t.game.newGame(),e.stopImmediatePropagation()}),window.addEventListener("lostlevel",e=>{t.lost.showModal()})}function W(){t.pause=document.querySelector(`#pause-dialog-${w}`),t.pause.querySelector("button").addEventListener("click",e=>{t.pause.close(),t.game.unpause(),e.stopImmediatePropagation()}),window.addEventListener("pause",e=>{t.pause.showModal()})}function N(){t.countdownDialog=document.querySelector("#countdown-dialog"),t.threeTwoOne=t.countdownDialog.querySelector("div>div"),window.addEventListener("showcountdown",()=>{t.countdownDialog.showModal(),t.threeTwoOne.textContent="3",t.threeTwoOne.className="three",setTimeout(()=>{t.threeTwoOne.textContent="2",t.threeTwoOne.className="two",setTimeout(()=>{t.threeTwoOne.textContent="1",t.threeTwoOne.className="one",setTimeout(()=>{t.countdownDialog.close(),t.threeTwoOne.className=""},416)},416)},416)})}function I(){t.settingsDialog=document.querySelector("#settings-dialog"),window.addEventListener("showsettings",()=>{t.settingsDialog.showModal()})}function z(){console.info("%cTracer %cstarted.","color: #f33; font-weight: bold","color: initial; font-weight: normal;"),"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js").then(o=>{console.info(`Service Worker registered with scope "${o.scope}"`)}).catch(o=>{console.error(`Service Worker registration failed: ${o}`)}),customElements.define("tracer-game",g),t.game=document.querySelector("tracer-game"),t.countdown=document.querySelector("#countdown"),addEventListener("countdown",o=>{t.countdown.textContent=o.detail}),document.addEventListener("touchstart",()=>t.game.resumeAudio(),{once:!0}),document.addEventListener("click",()=>t.game.resumeAudio(),{once:!0}),addEventListener("keyup",L),addEventListener("resize",()=>t.game.adjustSize()),N(),I(),P(),C(),W(),A().showModal()}addEventListener("pageshow",z)})(Game||(Game={}));
