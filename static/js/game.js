var P={N:{dx:0,dy:-1},S:{dx:0,dy:1},E:{dx:1,dy:0},W:{dx:-1,dy:0},NE:{dx:1,dy:-1},NW:{dx:-1,dy:-1},SE:{dx:1,dy:1},SW:{dx:-1,dy:1}};Object.freeze(P);var A={NE:7,E:6,SE:5,S:4,SW:3,W:2,NW:1,N:0};Object.freeze(A);var h=[[.08,1.42,.08],[.28,0,.28],[1.1,0,1.1]],u={NE:["S","W","SW"],NW:["S","E","SE"],SE:["N","W","NW"],SW:["N","E","NE"],N:["SW","SE","S"],E:["NW","SW","W"],S:["NE","NW","N"],W:["NE","SE","E"]},c;(function(g){g[g.Fluid=0]="Fluid",g[g.Step=1]="Step",g[g.Path=2]="Path"})(c||(c={}));var b;(function(g){let a;(function(s){s[s.None=0]="None",s[s.Splash=1]="Splash",s[s.Play=2]="Play",s[s.Countdown=3]="Countdown",s[s.AnimatePath=4]="AnimatePath",s[s.Paused=5]="Paused",s[s.Help=6]="Help",s[s.Wrong=7]="Wrong",s[s.Won=8]="Won",s[s.Start=9]="Start",s[s.Lost=10]="Lost"})(a||(a={}));function m(s){return new Promise(e=>setTimeout(e,s))}class p extends HTMLElement{constructor(){super(),this._state=a.None,this.lastTapTime=0,this._soundEnabled=!0,this.sounds={},this.path=[],this.pathIndex=0,this.elapsed=0,this.prelude=!0,this._creatingPath=!1}connectedCallback(){this.shadow=this.attachShadow({mode:"open"}),this.dynamicStyles=document.createElement("style");let e=document.createElement("style");e.textContent=`
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    touch-action: manipulation;
    font-size: calc(var(--cell-size) / 2);
}
#board {
    position: relative;
    margin: 0 auto;
    width: fit-content;
    display: grid;
    grid-template-columns: repeat(var(--tiles-per-row), var(--cell-size));
    grid-template-rows: repeat(--tiles-per-col, var(--cell-size));
    gap: calc(var(--cell-size) / 10);
}
#board.locked > div.tile {
    cursor: not-allowed;
}
#board.wrong > div.tile {
    background-color: var(--wrong-color);
    box-shadow: 0 0 calc(var(--cell-size) / 10) calc(var(--cell-size) / 30) var(--wrong-color);
    cursor: not-allowed;
}
#board.go > div.tile.path {
    background-color: var(--go-color);
    box-shadow: 0 0 calc(var(--cell-size) / 10) calc(var(--cell-size) / 30) var(--go-color);
}
.tile {
    display: block;
    box-sizing: content-box;
    width: var(--cell-size);
    height: var(--cell-size);
    background-color: var(--tile-color);
    border-radius: calc(var(--cell-size) / 30);
    cursor: pointer;
    text-align: center;
    line-height: var(--cell-size);
    transition: background-color 60ms, box-shadow 60ms;
}
.tile.path {
    animation-name: path;
    animation-iteration-count: 1;
    animation-fill-mode: alternate;
    animation-timing-function: cubic-bezier(.32,.36,.04,.96);
}
.tile.step {
    background-color: var(--path-color);
    box-shadow: 0 0 calc(var(--cell-size) / 7) calc(var(--cell-size) / 30) var(--path-color);
}
.tile.visited {
    background-color: var(--visited-color);
    box-shadow: 0 0 calc(var(--cell-size) / 6) calc(var(--cell-size) / 30) var(--visited-color);
}
@keyframes path {
    0% {
        background-color: var(--tile-color);
    }
    50% {
        background-color: var(--path-color);
        box-shadow: 0 0 calc(var(--cell-size) / 7) calc(var(--cell-size) / 30) var(--path-color);
    }
}`,this.board=document.createElement("div"),this.board.classList.add("locked"),this.board.id="board",this.shadow.appendChild(this.board),this.shadow.appendChild(this.dynamicStyles),this.shadow.appendChild(e),this.activateEventListeners(),this.initWorker(),this.initAudio()}initWorker(){this.worker=new Worker("./static/js/creator.js",{type:"module"}),this.worker.onmessage=e=>{var i;let{dt:n,numTries:d,path:l}=e.data;this._creatingPath=!1,this.path=l,(i=this.pathReadyCallback)===null||i===void 0||i.call(l),console.info(`New path with ${l.length} steps created in ${n}ms after ${d} tries: ${l.map(({x:o,y:r})=>`(${o},${r})`).join(" \u2192 ")}`)},this.worker.onerror=e=>{console.error(e)},this.worker.onmessageerror=e=>{console.error(e)}}updateDynamicStyles(){this.dynamicStyles.textContent=`
:host {
    --cell-size: ${80/Math.max(this.level.width,this.level.height)}vmin;
    --tiles-per-row: ${this.level.width};
    --tiles-per-col: ${this.level.height};
}
.tile.path {
    animation-duration: ${this.level.tileAnimationDurationSecs}s;
}
`}get levelCount(){return p.Levels.length}adjustSize(){this.updateDynamicStyles()}buildBoard(){this.tiles=Array.from({length:this.level.height},()=>Array(this.level.width).fill(null));for(let e=0;e<this.level.height;++e)for(let i=0;i<this.level.width;++i){let n=document.createElement("div");n.classList.add("tile"),n.dataset.x=i.toString(),n.dataset.y=e.toString(),this.tiles[e][i]=n}this.board.addEventListener("click",e=>{e.target.classList.contains("tile")&&this.onTileClick(e)}),this.board.replaceChildren(...this.tiles.flat())}set difficulty(e){var i;if(e===this.difficulty){(i=this.pathReadyCallback)===null||i===void 0||i.call(this,this.path);return}this.level=p.Levels[Math.min(e,p.Levels.length-1)],this.updateDynamicStyles(),this.buildBoard(),this.createPath()}get difficulty(){return Math.max(0,p.Levels.indexOf(this.level))}get creatingPath(){return this._creatingPath}animatePath(){switch(this.level.animationStyle){case c.Fluid:let e=this.level.tileAnimationDurationSecs/(this.path.length*3);this.path.forEach(({x:n,y:d},l)=>{let o=this.tiles[d][n];o.classList.add("path"),o.style.animationDelay=`${l*e}s`});break;case c.Path:let i=this.level.tileAnimationDurationSecs/this.path.length;this.path.forEach(({x:n,y:d},l)=>{setTimeout(()=>{this.tiles[d][n].classList.add("step")},1e3*l*i)});break;case c.Step:this.path.forEach(({x:n,y:d},l)=>{m(1e3*l*this.level.tileAnimationDurationSecs/this.path.length).then(()=>{this.tiles[d][n].classList.add("step"),m(1e3*this.level.tileAnimationDurationSecs/this.path.length).then(()=>{this.tiles[d][n].classList.remove("step")})})});break}}createPath(){if(console.debug("createPath()",this._creatingPath),this._creatingPath)return;let e={width:this.level.width,height:this.level.height,numStepsRequired:this.level.numStepsRequired,directionWeights:this.level.directionWeights,forbiddenTurns:this.level.forbiddenTurns,crossingAllowed:this.level.crossingAllowed};this._creatingPath=!0,this.worker.postMessage(e)}registerPathReadyCallback(e){this.pathReadyCallback=e}unregisterPathReadyCallback(){this.pathReadyCallback=void 0}activateEventListeners(){addEventListener("touchstart",e=>this.onTouchStart(e),{passive:!1}),addEventListener("touchend",e=>this.onTouchEnd(e)),addEventListener("resize",()=>this.adjustSize())}newGame(){this.prelude=!0,this.state=a.Start}update(){this.prelude||![a.AnimatePath,a.Play,a.Wrong].includes(this._state)||(this.elapsed=.001*(performance.now()-this.t0),dispatchEvent(new CustomEvent("countdown",{detail:Math.max(0,this.level.secsToSolve-this.elapsed).toFixed(2)})),this.elapsed>this.level.secsToSolve&&(this.state=a.Lost),this.animationFrameID=requestAnimationFrame(()=>this.update()))}set state(e){if(this._state!==e)switch(this._state=e,e){case a.Start:this.elapsed=0,this.state=a.Countdown,dispatchEvent(new CustomEvent("countdown",{detail:this.level.secsToSolve.toFixed(2)}));break;case a.Countdown:this.playSound("countdown"),dispatchEvent(new CustomEvent("showcountdown")),m(1400).then(()=>{this.state=a.AnimatePath});break;case a.AnimatePath:this.board.classList.remove("go"),this.pathIndex=0,this.animatePath(),m(1e3*this.level.tileAnimationDurationSecs).then(()=>{this.state=a.Play,this.animationFrameID=requestAnimationFrame(()=>this.update())});break;case a.Play:this.playSound("pip"),this.board.classList.remove("locked"),this.board.classList.add("go"),m(100).then(()=>{this.board.classList.remove("go"),this.tiles.flat().forEach(i=>i.classList.remove("path","step"))}),this.t0=performance.now()-1e3*this.elapsed,this.animationFrameID=requestAnimationFrame(()=>this.update()),this.prelude=!1;break;case a.Wrong:this.playSound("alarm"),this.board.classList.add("wrong"),this.tiles.flat().forEach(i=>i.classList.remove("visited")),m(1e3*this.sounds.alarm.buffer.duration).then(()=>{this.board.classList.remove("wrong"),.001*(performance.now()-this.t0)<this.level.secsToSolve&&(this.state=a.Countdown)}),this.animationFrameID=requestAnimationFrame(()=>this.update());break;case a.Paused:this.board.classList.add("locked"),dispatchEvent(new CustomEvent("pause")),cancelAnimationFrame(this.animationFrameID);break;case a.Won:cancelAnimationFrame(this.animationFrameID),this.board.classList.add("locked"),this.playSound("tada"),this.tiles.flat().forEach(i=>i.classList.remove("visited")),this.createPath(),dispatchEvent(new CustomEvent("wonlevel")),this.elapsed=0;break;case a.Lost:clearTimeout(this.timeoutID),cancelAnimationFrame(this.animationFrameID),this.stopAllSounds(),this.playSound("alarm"),this.board.classList.remove("wrong"),this.tiles.flat().forEach(i=>i.classList.remove("visited","path","step")),this.createPath(),dispatchEvent(new CustomEvent("lostlevel"));break;case a.Splash:t.countdown.textContent=this.level.secsToSolve.toFixed(2);break;default:break}}get state(){return this._state}onTileClick(e){if(e.preventDefault(),e.stopImmediatePropagation(),this._state!==a.Play)return;let i=e.target,n=parseInt(i.dataset.x),d=parseInt(i.dataset.y),l=this.tiles[d][n],o=this.path[this.pathIndex];o.x===n&&o.y===d?(this.playSound("step"),l.classList.add("visited"),++this.pathIndex,this.pathIndex===this.path.length&&(this.state=a.Won)):this.state=a.Wrong}onTouchStart(e){this.touchStartTime=performance.now()}onTouchEnd(e){let i=performance.now();if(i-this.touchStartTime<400){let l=e.changedTouches[0],o=document.elementFromPoint(l.clientX,l.clientY);if(o.classList.contains("tile")){let r=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window,clientX:l.clientX,clientY:l.clientY}),w=Object.create(r,{target:{value:o},currentTarget:{value:o}});this.onTileClick(w)}}let d=i-this.lastTapTime;d<500&&d>0&&e.preventDefault(),this.lastTapTime=i}set soundEnabled(e){this._soundEnabled=e,localStorage.setItem("tracer-sound-enabled",this.soundEnabled.toString())}get soundEnabled(){return this._soundEnabled}pause(){this.state=a.Paused}unpause(){this.state=a.Play}lose(){this.state=a.Lost}doPlaySound(e){let i=this.audioCtx.createBufferSource();i.buffer=this.sounds[e].buffer,i.connect(this.gainNode),i.start(),this.sounds[e].source=i}playSound(e){this.soundEnabled&&(this.audioCtx.state==="suspended"?this.resumeAudio().then(()=>{this.doPlaySound(e)}):this.doPlaySound(e))}stopSound(e){this.sounds[e].source&&this.sounds[e].source.stop()}stopAllSounds(){for(let e in this.sounds)this.stopSound(e)}resumeAudio(){return this.audioCtx.resume()}initAudio(){this.audioCtx=new AudioContext,this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=parseFloat(localStorage.getItem("tracer-sound-volume")||p.DEFAULT_GAIN_VALUE.toString()),this.gainNode.connect(this.audioCtx.destination);for(let e of["countdown","alarm","step","tada","pip"])this.sounds[e]={},fetch(`static/sounds/${e}.mp3`).then(i=>i.arrayBuffer()).then(i=>this.audioCtx.decodeAudioData(i)).then(i=>{this.sounds[e].buffer=i}).catch(i=>{console.error("Failed to load sound:",i)})}}p.DEFAULT_GAIN_VALUE=.5,p.Levels=[{crossingAllowed:!1,directionWeights:h,forbiddenTurns:u,width:4,height:4,secsToSolve:20,tileAnimationDurationSecs:3,numStepsRequired:5,animationStyle:c.Path},{crossingAllowed:!1,directionWeights:h,forbiddenTurns:u,width:5,height:4,secsToSolve:30,tileAnimationDurationSecs:2.5,numStepsRequired:7,animationStyle:c.Path},{crossingAllowed:!1,directionWeights:h,forbiddenTurns:u,width:5,height:4,secsToSolve:30,tileAnimationDurationSecs:2.5,numStepsRequired:8,animationStyle:c.Path},{crossingAllowed:!1,directionWeights:h,forbiddenTurns:u,width:5,height:5,secsToSolve:30,tileAnimationDurationSecs:2.3,numStepsRequired:10,animationStyle:c.Fluid},{crossingAllowed:!1,directionWeights:h,forbiddenTurns:u,width:5,height:6,secsToSolve:30,tileAnimationDurationSecs:2.2,numStepsRequired:11,animationStyle:c.Fluid},{crossingAllowed:!1,directionWeights:h,forbiddenTurns:u,width:6,height:6,secsToSolve:30,tileAnimationDurationSecs:3,numStepsRequired:13,animationStyle:c.Fluid},{crossingAllowed:!1,directionWeights:h,forbiddenTurns:u,width:7,height:6,secsToSolve:30,tileAnimationDurationSecs:2.5,numStepsRequired:14,animationStyle:c.Fluid},{crossingAllowed:!1,directionWeights:h,forbiddenTurns:u,width:8,height:7,secsToSolve:30,tileAnimationDurationSecs:1.5,numStepsRequired:15,animationStyle:c.Fluid},{crossingAllowed:!0,directionWeights:h,forbiddenTurns:u,width:9,height:9,secsToSolve:30,tileAnimationDurationSecs:5,numStepsRequired:20,animationStyle:c.Path}];let t={},v=document.location.hostname.startsWith("leuchtspur")?"de":"en";function S(s){switch(s.key){case"Escape":if(t.splash.open)return;switch(t.game.state){case a.Play:t.game.pause();break;case a.Paused:t.game.unpause();break;default:break}break;case"x":t.game.lose();break;default:break}s.preventDefault(),s.stopImmediatePropagation()}function f(s,e){let i=[],n=o=>{let r=()=>{s.close(),i[t.game.difficulty].disabled=!1,t.game.newGame()};t.game.registerPathReadyCallback(w=>{t.game.creatingPath?t.game.registerPathReadyCallback(r):(t.game.unregisterPathReadyCallback(),r())}),t.game.resumeAudio().then(()=>{t.game.difficulty=o})},d=document.querySelector(`#difficulty-template-${e}`).content.cloneNode(!0);for(let o=0;o<t.game.levelCount;++o){let r=document.createElement("button");r.textContent=(o+1).toString(),d.appendChild(r),i.push(r)}s.appendChild(d),s.addEventListener("toggle",()=>{i[t.game.difficulty].textContent=(t.game.difficulty+1).toString(),i[t.game.difficulty].focus()});let l=document.querySelector("#loader-icon").content.cloneNode(!0);s.addEventListener("keydown",o=>{if("1"<=o.key&&o.key<=`${t.game.levelCount}`){let r=parseInt(o.key)-1;n(r),i[r].disabled=!0,i[r].replaceChildren(l),o.preventDefault(),o.stopImmediatePropagation()}}),s.addEventListener("click",o=>{if(o.target instanceof HTMLButtonElement){let r=parseInt(o.target.textContent||"1")-1;n(r),i[r].disabled=!0,i[r].replaceChildren(l)}o.stopImmediatePropagation(),o.preventDefault()})}function y(){return t.splash=document.querySelector(`#splash-screen-${v}`),t.splash.addEventListener("cancel",s=>s.preventDefault()),f(t.splash,v),t.splash}function E(){t.won=document.querySelector(`#won-dialog-${v}`),t.won.addEventListener("cancel",s=>s.preventDefault()),window.addEventListener("wonlevel",s=>{t.won.showModal()}),f(t.won,v)}function k(){t.lost=document.querySelector(`#lost-dialog-${v}`),t.lost.addEventListener("cancel",s=>s.preventDefault()),window.addEventListener("lostlevel",s=>{t.lost.showModal()}),f(t.lost,v)}function L(){t.pause=document.querySelector(`#pause-dialog-${v}`),t.pause.querySelector("button").addEventListener("click",e=>{t.pause.close(),t.game.unpause(),e.stopImmediatePropagation()}),window.addEventListener("pause",e=>{t.pause.showModal()})}function T(){t.countdownDialog=document.querySelector("#countdown-dialog"),t.threeTwoOne=t.countdownDialog.querySelector("div>div"),window.addEventListener("showcountdown",()=>{t.countdownDialog.showModal(),t.threeTwoOne.textContent="3",t.threeTwoOne.className="three",m(416).then(()=>{t.threeTwoOne.textContent="2",t.threeTwoOne.className="two",m(416).then(()=>{t.threeTwoOne.textContent="1",t.threeTwoOne.className="one",m(416).then(()=>{t.countdownDialog.close(),t.threeTwoOne.className=""})})})})}function D(){t.settingsDialog=document.querySelector("#settings-dialog"),window.addEventListener("showsettings",()=>{t.settingsDialog.showModal()})}function x(){console.info("%cTracer %cstarted.","color: #f33; font-weight: bold","color: initial; font-weight: normal;"),"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js").then(e=>{console.info(`Service Worker registered with scope "${e.scope}"`)}).catch(e=>{console.error(`Service Worker registration failed: ${e}`)}),customElements.define("tracer-game",p),t.game=document.querySelector("tracer-game"),t.countdown=document.querySelector("#countdown"),addEventListener("countdown",e=>{t.countdown.textContent=e.detail}),document.addEventListener("touchstart",()=>t.game.resumeAudio(),{once:!0}),document.addEventListener("click",()=>t.game.resumeAudio(),{once:!0});let s=parseInt(localStorage.getItem("tracer-difficulty")||"0");t.game.difficulty=s,addEventListener("keyup",S),T(),D(),E(),k(),L(),y().showModal()}addEventListener("pageshow",x),addEventListener("beforeunload",()=>{localStorage.setItem("tracer-difficulty",t.game.difficulty.toString())})})(b||(b={}));
